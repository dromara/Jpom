---
title: 迁移数据
date: 2023-12-23 17:15:45
permalink: /pages/dec2a1/
categories:
  - docs
  - 文档
  - 如何升级&迁移
tags:
  - 
---

## 完整迁移

完整迁移是指当您旧环境还能正常使用新环境已经准备 OK 就只需要迁移程序和数据

> 注意：因为您使用文件迁移的方式并也迁移了配置文件，理论上无论您使用什么数据库均适用此流程

### 服务端（原生本地安装）

当前说明是指您使用原生本地安装的方式，并非使用容器安装的情况

当您当新环境（机器/服务器）已经准备好了，请您先根据旧环境中的依赖和插件提前安装和进行环境变量配置（此步骤本文档默认您已经会了并且配置 OK）

一般情况下依赖如下：

- jdk 必须
- maven 可选
- node 可选
- 服务器字体 可选（验证码相关）
- 网络 （新环境和所有节点机器、SSH 机器、Docker 机器）
- 数据库网络 （如果使用了 mysql 数据库）


------------

#### 开始迁移流程

----------

#### 关闭旧环境服务端

先关闭旧环境服务端来保证已经没有新的操作和请求造成迁移过程中产生数据影响数据完整性

```shell
sh ./bin/Server.sh stop
```

```shell
./bin/Server.bat stop
```

----------

#### 决定需要迁移的目录

为了数据安全和稳定我们建议您先 copy 服务端的整个目录进行操作，避免操作过程中的误操作造成数据丢失。

当您 copy 出新目录后您可以开始选择把不需要的迁移的目录或者文件删除

比如如下目录您可以选择不迁移：

- logs
- tmp
- data/temp
- data/script_run_cache

慎重选择：如果您迁移时候发现 `data/build` 目录非常大严重影响您的备份效率，此时您需要评估在线构建中缓存的仓库数据、构建日志、构建产物是否可以容忍丢失。

如果能容忍丢失那么您可以选择删除 `data/build` 目录。

如果您想保留部分构建仓库数据、构建日志、构建产物数据，那么您需要先知道想保留的构建的`数据 ID`。

怎么获取构建数据 ID,我相信您一定知道浏览器的调试控制台->网络选项卡（说到这里了懂的都懂，不懂的问度娘）

获取到您需要保留的数据 ID 后，您将不需要保留的构建数据删除即可 `data/build/数据 ID`

----------

#### 打包整个目录并下载

打包目录这个不用说了吧

linux 推荐用：tar

windows 您喜好

为什么需要打包呢？不能直接下载目录吗？

当您有这个疑问时说明您不知道在网络中，`上传/下载`多个小文件和`上传/下载`一个大文件的效率问题,反正推荐压缩打包后进行传输，极其不推荐直接传输整个目录。

----------

#### 上传备份文件到新环境

当您打包后到文件下载到本地或者直接传输到新环境。

如果您是下载到本地那么您还需要将文件上传到新环境中。

----------

#### 确认新环境准备完毕

上面已经说明了，需要您提前在新环境中安装旧环境中相关的依赖插件。

这里我们建议您新环境中使用插件版本和旧环境中的版本号和安装方式一直，来减少新环境中遇到各种奇奇乖乖的依赖环境不正确的问题

----------

#### 启动服务端

但您环境确认完毕后，即可启动服务端

```shell
sh ./bin/Server.sh start
```

```shell
./bin/Server.bat start
```

期待您顺利启动。

如果启动失败请根据错误日志来排查定位相关问题（您也可以联系我们协助排查）

----------

#### 检查是否需要安装服务

如果您之前注册过开机启动服务，您还需要使用之前相同方式来在新机器中注册服务并开启开机自启

Linux：

```shell
bash /xxxx/bin/Service.sh install
```

Windows:

自行实现

----------

#### 确认访问

当新环境启动成功后，您需要使用新 IP 访问系统，如果使用到了反向代理您还需要修改反向代理的配置来达到可以正常访问

----------

#### 检查系统是否正常

使用账户密码登陆到新系统中来检查数据是否完成，资产数据连接是否正常

#### 正常使用

当您一切都检查 ok 无问题后您就可以在新环境中使用 jpom 啦，不要忘记将新环境的地址告知给其他使用平台的用户奥

----------

### 插件端

:::danger 说明
- 本文中仅说明如果迁移 jpom 插件端，如果您对呀服务端里面包含项目数据还您你自行迁移。迁移服务器中其他数据不在本文说明范畴.
- 机器关联的项目数据迁移是一个极其麻烦的事情您自己想要了解并知道该如何迁移。
- 如果仅迁移插件端未迁移机器中的项目数据那么可能造成在 Jpom 系统中看到项目状态是未运行和无法看到项目的任何文件。
:::

当您当新环境（机器/服务器）已经准备好了，请您先根据旧环境中的依赖和插件提前安装和进行环境变量配置（此步骤本文档默认您已经会了并且配置 OK）

一般情况下依赖如下：

- jdk 必须
- 项目数据 【自行判断】
- 网络 （服务端能否访问到新环境）

#### 开始迁移流程

#### 关闭旧环境服务端

先关闭旧环境服务端来保证已经没有新的操作和请求造成迁移过程中产生数据影响数据完整性

```shell
sh ./bin/Agent.sh stop
```

```shell
./bin/Agent.bat stop
```

----------

#### 决定需要迁移的目录

为了数据安全和稳定我们建议您先 copy 服务端的整个目录进行操作，避免操作过程中的误操作造成数据丢失。

当您 copy 出新目录后您可以开始选择把不需要的迁移的目录或者文件删除

比如如下目录您可以选择不迁移：

- logs
- tmp
- data/temp
- data/script_run_cache
- data/script

慎重选择：如果您迁移时候发现 `data/script` 目录非常大严重影响您的备份效率，此时您需要评估节点脚本日志是否可以容忍丢失。

如果能容忍丢失那么您可以选择删除 `data/script` 目录。

如果您想保留部分节点脚本日志数据，那么您需要先知道想保留的脚本的`数据 ID`。

怎么获取脚本数据 ID,我相信您一定知道浏览器的调试控制台->网络选项卡（说到这里了懂的都懂，不懂的问度娘）

获取到您需要保留的数据 ID 后，您将不需要保留的脚本日志数据删除即可 `data/script/数据 ID`

----------


#### 打包整个目录并下载

打包目录这个不用说了吧

linux 推荐用：tar

windows 您喜好

为什么需要打包呢？不能直接下载目录吗？

当您有这个疑问时说明您不知道在网络中，`上传/下载`多个小文件和`上传/下载`一个大文件的效率问题,反正推荐压缩打包后进行传输，极其不推荐直接传输整个目录。

----------

#### 上传备份文件到新环境

当您打包后到文件下载到本地或者直接传输到新环境。

如果您是下载到本地那么您还需要将文件上传到新环境中。

----------

#### 确认新环境准备完毕

上面已经说明了，需要您提前在新环境中安装旧环境中相关的依赖插件。

这里我们建议您新环境中使用插件版本和旧环境中的版本号和安装方式一直，来减少新环境中遇到各种奇奇乖乖的依赖环境不正确的问题

----------

#### 启动插件端

但您环境确认完毕后，即可启动插件端

```shell
sh ./bin/Agent.sh start
```

```shell
./bin/Agent.bat start
```

期待您顺利启动。

如果启动失败请根据错误日志来排查定位相关问题（您也可以联系我们协助排查）

----------

#### 检查是否需要安装服务

如果您之前注册过开机启动服务，您还需要使用之前相同方式来在新机器中注册服务并开启开机自启

Linux：

```shell
bash /xxxx/bin/Service.sh install
```

Windows:

自行实现

----------

#### 修改机器节点地址

使用管理员账户登陆到服务端中，【系统管理】->【资产管理】->【机器管理】 中找到对应机器节点的数据编辑节点，修改其地址为新的 IP 地址

----------

#### 检查节点是否正常

当您上述操作均成功后，您需要在 Jpom 系统中来检查您的节点是否可以正常连接，如果不能正常连接请检查网络限制相关问题

您还需要建议此插件端机器中的项目数据是否正常（此流程不可控需要您清楚您项目是否迁移完成）

----------

> 注意：因为您使用文件迁移的方式并也迁移了配置文件，理论上无论您使用什么数据库均是此流程

## 部分迁移

部分迁移是指您您想将旧环境数据导入或者迁移到新环境，旧环境中的历史记录日志和缓存均可以丢弃。

### 服务端（原生本地安装）

关于服务端数据的总结：

- db 核心数据
- conf 配置文件夹
- data/INSTALL.json 安装ID/集群ID

关于 db ：`Server.mv.db`、`Server.trace.db` 是最新的完整数据

其他目录的数据均是使用过程中的数据：`文件中心`、`证书文件`、`构建数据` 想要您看是否使用到对应功能和是否重要以及有备份。

自行选择选择使用过程中的数据是否迁移。

#### 开始迁移流程

----------

#### 关闭旧环境服务端

先关闭旧环境服务端来保证已经没有新的操作和请求造成迁移过程中产生数据影响数据完整性

```shell
sh ./bin/Server.sh stop
```

```shell
./bin/Server.bat stop
```

----------

#### 决定需要迁移的目录

根据上述描述选择您需要迁移的文件及文件夹

为了数据安全和稳定我们建议您先 copy 服务端的整个目录进行操作，避免操作过程中的误操作造成数据丢失。

当您 copy 出新目录后您可以开始选择把不需要的迁移的目录或者文件删除

----------

#### 后续流程和上面完整迁移一致

后续流程和上面完整迁移一致，请先仔细阅读完整迁移的流程

部分迁移和完整迁移的区别主要是选择的迁移数据的范围不同

----------

### 插件端

:::danger 提示
- 由于插件端数据较少，部分迁移和完整迁移流程和选择方式一致，请参考完整迁移流程
- 绝大多数情况下我们建议插件端均采用完整迁移，但是需要考虑对应服务器中的项目数据迁移情况
:::

